@model Aiursoft.AiurDrive.Models.DashboardViewModels.FileManagerViewModel
@inject Aiursoft.AiurDrive.Services.FileStorage.StorageService Storage
@{
    ViewData["Title"] = "File Manager - " + Model.SiteName;
}

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">@Localizer["File Manager"] - @Model.SiteName</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
             @if (!string.IsNullOrEmpty(Model.Path))
             {
                var parentPath = System.IO.Path.GetDirectoryName(Model.Path)?.Replace("\\", "/");
                <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@parentPath" class="btn btn-sm btn-outline-secondary me-2">
                    <i class="fas fa-arrow-up"></i> @Localizer["Up Level"]
                </a>
             }
        </div>
    </div>

    <div class="row">
        <!-- Sidebar / Stats -->
        <div class="col-sm-5 col-xl-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-grid mb-3">
                         <!-- Upload Component -->
                         <h6 class="card-title">@Localizer["Upload File"]</h6>
                         <vc:file-upload
                            asp-for="UploadedFilePath"
                            upload-endpoint="@Url.Action("Upload", "Dashboard", new { siteName = Model.SiteName, path = Model.Path })"
                            allowed-extensions=""
                            max-size-in-mb="1024"
                            on-upload-success="reloadPage">
                        </vc:file-upload>
                        <small class="text-muted text-center mt-2">@Localizer["Files are saved immediately upon upload."]</small>
                         <a href="javascript:location.reload();" class="btn btn-secondary mt-2"><i class="fas fa-sync"></i> Refresh List</a>
                    </div>

                    <h6 class="text-uppercase mt-4">@Localizer["Current Location"]</h6>
                    <p class="text-muted font-12 mb-0">
                        /@Model.SiteName/@Model.Path
                    </p>
                </div>
            </div>
        </div>

        <!-- File List -->
        <div class="col-sm-7 col-xl-9">
            <div class="card">
                <div class="card-header pb-0">
                    <h5 class="card-title mt-2">
                        @Localizer["Files"]
                        @if(!string.IsNullOrEmpty(Model.Path)) { <span>/ @Model.Path</span> }
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-50">@Localizer["Name"]</th>
                                <th>@Localizer["Date Modified"]</th>
                                <th>@Localizer["Size"]</th>
                                <th class="text-end">@Localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var folder in Model.Folders)
                            {
                                <tr>
                                    <td>
                                        <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@(string.IsNullOrEmpty(Model.Path) ? folder : Model.Path + "/" + folder)" class="text-reset fw-bold">
                                            <i class="fas fa-folder text-warning me-2"></i>@folder
                                        </a>
                                    </td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td class="text-end">
                                        <form asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@(string.IsNullOrEmpty(Model.Path) ? folder : Model.Path + "/" + folder)" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');">
                                            <button type="submit" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                                        </form>
                                    </td>
                                </tr>
                            }

                            @foreach (var file in Model.Files)
                            {
                                var logicalPath = System.IO.Path.Combine(Model.SiteName, Model.Path, file.Name).Replace("\\", "/");
                                var directUrl = Storage.RelativePathToInternetUrl(logicalPath, !Model.OpenToUpload);
                                <tr>
                                    <td>
                                        <a href="@directUrl" target="_blank" class="text-reset">
                                            <i class="fas fa-file text-primary me-2"></i>@file.Name
                                        </a>
                                    </td>
                                    <td>@file.LastWriteTime.ToString("g")</td>
                                    <td>@((file.Length / 1024.0).ToString("N0")) KB</td>
                                    <td class="text-end">
                                        <a href="@directUrl" target="_blank" class="btn btn-sm btn-light"><i class="fas fa-download"></i></a>
                                        <form asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@(string.IsNullOrEmpty(Model.Path) ? file.Name : Model.Path + "/" + file.Name)" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                            <button type="submit" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                                        </form>
                                    </td>
                                </tr>
                            }

                            @if (!Model.Files.Any() && !Model.Folders.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted">@Localizer["Folder is empty."]</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/node_modules/dropify/dist/css/dropify.min.css" />
    <link rel="stylesheet" href="~/styles/uploader.css" />
}
@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script src="~/node_modules/dropify/dist/js/dropify.min.js"></script>
    <script>
        $(document).ready(function() {
            // Optional: Auto-refresh on upload completion if dropify supports events easily,
            // but standard dropify just shows the file.
            // We provided a Refresh button for now.
        });

        function reloadPage() {
            location.reload();
        }
    </script>
}
