@model Aiursoft.AiurDrive.Models.DashboardViewModels.FileManagerViewModel
@inject Aiursoft.AiurDrive.Services.FileStorage.StorageService Storage
@using Aiursoft.CSTools.Tools
@{
    ViewData["Title"] = "File Manager - " + Model.SiteName;
    string GetFileIcon(string filename)
    {
        var icon = Aiursoft.CSTools.Models.Mime.GetIcon(filename);
        return $"/images/mimetypes/{icon}";
    }
}

<div class="container-fluid p-0">
    <!-- Breadcrumb -->
    <div class="pt-3 pb-2 mb-3 border-bottom">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="">
                        <i class="fas fa-home"></i> @Model.SiteName
                    </a>
                </li>
                @if (!string.IsNullOrEmpty(Model.Path))
                {
                    var parts = Model.Path.Split('/');
                    for (int i = 0; i < parts.Length; i++)
                    {
                        var part = parts[i];
                        var currentPath = string.Join("/", parts.Take(i + 1));

                        if (i == parts.Length - 1)
                        {
                            <li class="breadcrumb-item active" aria-current="page">@part</li>
                        }
                        else
                        {
                            <li class="breadcrumb-item">
                                <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@currentPath">@part</a>
                            </li>
                        }
                    }
                }
            </ol>
        </nav>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-sm-5 col-xl-3 mb-3">
            @if (Model.IsOwner)
            {
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">@Localizer["Site Management"]</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a asp-controller="Shares" asp-action="Manage" asp-route-siteName="@Model.SiteName" class="list-group-item list-group-item-action">
                            <i class="align-middle me-1" data-lucide="share-2"></i> @Localizer["Manage Shares"]
                        </a>
                        <a asp-action="EditSite" asp-route-siteName="@Model.SiteName" class="list-group-item list-group-item-action">
                            <i class="align-middle me-1" data-lucide="edit-3"></i> @Localizer["Rename Site"]
                        </a>
                        <a asp-action="DeleteSite" asp-route-siteName="@Model.SiteName" class="list-group-item list-group-item-action text-danger">
                            <i class="align-middle me-1" data-lucide="trash-2"></i> @Localizer["Delete Site"]
                        </a>
                    </div>
                </div>
            }

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">@Localizer["Storage Usage"]</h5>
                </div>
                <div class="card-body">
                    @{
                        var usedSpaceGB = Model.UsedSpaceInBytes / 1024.0 / 1024.0 / 1024.0;
                        var totalSpaceGB = (double)Model.TotalSpaceInGB;
                        var percentage = (usedSpaceGB / totalSpaceGB) * 100;
                        var colorClass = percentage >= 100 ? "bg-danger" : percentage >= 80 ? "bg-warning" : "bg-success";
                    }

                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar @colorClass" role="progressbar" style="width: @percentage%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>@usedSpaceGB.ToString("0.00") GB</span>
                        <span>@totalSpaceGB.ToString("0.00") GB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- File List Container -->
        <div class="col-sm-7 col-xl-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        @Localizer["Files"]
                        @if(!string.IsNullOrEmpty(Model.Path)) { <span class="text-muted small">/ @Model.Path</span> }
                    </h5>
                    <div class="btn-toolbar">
                         @if (Model.HasWriteAccess)
                         {
                             <form asp-action="Move" asp-route-siteName="@Model.SiteName" method="post" id="pasteForm" class="d-none me-2">
                                 <input type="hidden" name="sourcePath" id="pasteSourcePath" />
                                 <input type="hidden" name="targetPath" value="@Model.Path" />
                                 <button type="submit" class="btn btn-sm btn-outline-success">
                                     <i class="fas fa-paste"></i> <span id="pasteButtonText">@Localizer["Paste"]</span>
                                 </button>
                                 <button type="button" class="btn btn-sm btn-outline-danger" onclick="cancelCut()">
                                     <i class="fas fa-times"></i>
                                 </button>
                             </form>
                         }

                         @if (!string.IsNullOrEmpty(Model.Path))
                         {
                             var parentPath = System.IO.Path.GetDirectoryName(Model.Path)?.Replace("\\", "/");
                             <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@parentPath" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-arrow-up"></i> @Localizer["Up Level"]
                            </a>
                         }

                         @if (Model.HasWriteAccess)
                         {
                             <button class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                                 <i class="fas fa-folder-plus"></i> @Localizer["New Folder"]
                             </button>
                         }

                         <button class="btn btn-sm btn-outline-secondary" onclick="toggleView()" id="viewToggleBtn" title="@Localizer["Toggle View"]">
                             <i class="fas fa-th-large" id="viewToggleIcon"></i>
                         </button>
                    </div>
                </div>
                <div class="card-body">

                    <!-- List View -->
                    <div id="listView">
                        <table class="table table-hover" id="fileTable">
                            <thead>
                                <tr>
                                    <th class="w-50">@Localizer["Name"]</th>
                                    <th>@Localizer["Date Modified"]</th>
                                    <th>@Localizer["Size"]</th>
                                    <th class="text-end" data-orderable="false">@Localizer["Actions"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var folder in Model.Folders)
                                {
                                    var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? folder : Model.Path + "/" + folder;
                                    <tr>
                                        <td data-sort="0_@folder">
                                            <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" class="text-reset fw-bold">
                                                <i class="fas fa-folder text-warning me-2"></i>@folder
                                            </a>
                                        </td>
                                        <td data-sort="0">-</td>
                                        <td data-sort="-1">-</td>
                                        <td class="text-end">
                                            @if (Model.HasWriteAccess)
                                            {
                                                <button type="button" class="btn btn-sm btn-light text-secondary" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@folder')">
                                                    <i class="fas fa-cut"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-light text-primary" onclick="openRenameModal('@folder', '@currentRelativePath')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');">
                                                    <button type="submit" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }

                                @foreach (var file in Model.Files)
                                {
                                    var logicalPath = System.IO.Path.Combine(Model.SiteName, Model.Path, file.Name).Replace("\\", "/");
                                    var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? file.Name : Model.Path + "/" + file.Name;
                                    var directUrl = Storage.RelativePathToInternetUrl(logicalPath, isVault: true);
                                    <tr>
                                @{
                                    var isImageInList = file.Name.IsStaticImage();
                                }
                                        <td data-sort="1_@file.Name">
                                            <a href="@directUrl" target="_blank" class="text-reset">
                                                @if (isImageInList && Model.AllowImagePreview)
                                                {
                                                    var thumbUrlList = directUrl + (directUrl.Contains("?") ? "&" : "?") + "w=200";
                                                    <img src="@thumbUrlList" class="me-2" style="max-height: 24px; vertical-align: middle;" alt="@file.Name" />
                                                }
                                                else
                                                {
                                                    <i class="fas fa-file text-primary me-2"></i>
                                                }
                                                @file.Name
                                            </a>
                                        </td>
                                        <td data-sort="@file.LastWriteTime.Ticks">@file.LastWriteTime.ToString("g")</td>
                                        <td data-sort="@file.Length">@((file.Length / 1024.0).ToString("N0")) KB</td>
                                        <td class="text-end">
                                            <a href="@directUrl" target="_blank" class="btn btn-sm btn-light"><i class="fas fa-download"></i></a>
                                            @if (Model.HasWriteAccess)
                                            {
                                                <button type="button" class="btn btn-sm btn-light text-secondary" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@file.Name')">
                                                    <i class="fas fa-cut"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-light text-primary" onclick="openRenameModal('@file.Name', '@currentRelativePath')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                                    <button type="submit" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Grid View -->
                    <div id="gridView" class="d-none">
                        <div class="row">
                            @foreach (var folder in Model.Folders)
                            {
                                var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? folder : Model.Path + "/" + folder;
                                <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                                    <div class="card h-100 text-center file-grid-card">
                                        <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" class="text-decoration-none text-dark flex-grow-1 d-flex flex-column align-items-center justify-content-center p-3">
                                            <i class="fas fa-folder fa-3x text-warning mb-2"></i>
                                            <span class="text-truncate w-100" title="@folder">@folder</span>
                                        </a>
                                        <div class="card-footer bg-transparent border-top-0">
                                            @if (Model.HasWriteAccess)
                                            {
                                                <div class="btn-group w-100">
                                                    <button type="button" class="btn btn-light text-secondary py-2" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@folder')" title="@Localizer["Cut"]">
                                                        <i class="fas fa-cut"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light text-primary py-2" onclick="openRenameModal('@folder', '@currentRelativePath')" title="@Localizer["Rename"]">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light text-danger py-2" onclick="if(confirm('Are you sure you want to delete this folder and all its contents?')) document.getElementById('delete-folder-@folder').submit();" title="@Localizer["Delete"]">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                <!-- Hidden form for delete -->
                                                <form id="delete-folder-@folder" asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-none"></form>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            @foreach (var file in Model.Files)
                            {
                                var logicalPath = System.IO.Path.Combine(Model.SiteName, Model.Path, file.Name).Replace("\\", "/");
                                var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? file.Name : Model.Path + "/" + file.Name;
                                var directUrl = Storage.RelativePathToInternetUrl(logicalPath, isVault: true);
                                var isImage = file.Name.IsStaticImage();

                                <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                                    <div class="card h-100 text-center file-grid-card">
                                        <a href="@directUrl" target="_blank" class="text-decoration-none text-dark flex-grow-1 d-flex flex-column align-items-center justify-content-center p-3">
                                            @if (isImage && Model.AllowImagePreview)
                                            {
                                                var thumbUrl = directUrl + (directUrl.Contains("?") ? "&" : "?") + "w=200";
                                                <img src="@thumbUrl" class="img-fluid mb-2 rounded" style="max-height: 80px; object-fit: contain;" alt="@file.Name" />
                                            }
                                            else
                                            {
                                                <img src="@GetFileIcon(file.Name)" class="img-fluid mb-2" style="max-height: 80px;" alt="@file.Name" />
                                            }
                                            <span class="text-truncate w-100" title="@file.Name">@file.Name</span>
                                        </a>
                                        <div class="card-footer bg-transparent border-top-0">
                                            @if (Model.HasWriteAccess)
                                            {
                                                 <div class="btn-group w-100">
                                                    <button type="button" class="btn btn-light text-secondary py-2" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@file.Name')" title="@Localizer["Cut"]">
                                                        <i class="fas fa-cut"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light text-primary py-2" onclick="openRenameModal('@file.Name', '@currentRelativePath')" title="@Localizer["Rename"]">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-light text-danger py-2" onclick="if(confirm('Are you sure you want to delete this file?')) document.getElementById('delete-file-@file.Name').submit();" title="@Localizer["Delete"]">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                <!-- Hidden form for delete -->
                                                <form id="delete-file-@file.Name" asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-none"></form>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (!Model.Files.Any() && !Model.Folders.Any())
                            {
                                <div class="col-12 text-center text-muted py-5">
                                    @Localizer["Folder is empty."]
                                </div>
                            }
                        </div>
                    </div>

                </div>
            </div>

            @if (Model.HasWriteAccess)
            {
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">@Localizer["Operations"]</h5>
                    </div>
                    <div class="card-body">
                        <h6>@Localizer["Upload File"]</h6>
                        @{
                            var usedSpaceGB2 = Model.UsedSpaceInBytes / 1024.0 / 1024.0 / 1024.0;
                            var totalSpaceGB2 = (double)Model.TotalSpaceInGB;
                            var percentage2 = (usedSpaceGB2 / totalSpaceGB2) * 100;
                            var isFull2 = percentage2 >= 100;
                        }
                        @if (!isFull2)
                        {
                            <vc:file-upload
                                asp-for="UploadedFilePath"
                                subfolder="@(Model.SiteName + "/" + Model.Path)"
                                is-vault="true"
                                allowed-extensions=""
                                max-size-in-mb="1024"
                                on-upload-success="reloadPage">
                            </vc:file-upload>
                        }
                        else
                        {
                            <div class="alert alert-danger" role="alert">
                                <div class="alert-icon">
                                    <i class="align-middle" data-lucide="alert-octagon"></i>
                                </div>
                                <div class="alert-message">
                                    <strong>@Localizer["Storage Full"]</strong>
                                    <span class="d-block small">@Localizer["Delete some files to free up space."]</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@if (Model.HasWriteAccess)
{
    <!-- Create Folder Modal -->
    <div class="modal fade" id="createFolderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="CreateFolder" asp-route-siteName="@Model.SiteName" asp-route-path="@Model.Path" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">@Localizer["New Folder"]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newFolderName" class="form-label">@Localizer["Folder Name"]</label>
                            <input type="text" class="form-control" id="newFolderName" name="newFolderName" required pattern="[^\\/:*?&quot;&lt;&gt;|]+" title="Invalid characters">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                        <button type="submit" class="btn btn-primary">@Localizer["Create"]</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal fade" id="renameModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Rename" asp-route-siteName="@Model.SiteName" method="post" id="renameForm">
                    <input type="hidden" name="path" id="renamePath" />
                    <div class="modal-header">
                        <h5 class="modal-title">@Localizer["Rename"]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newName" class="form-label">@Localizer["New Name"]</label>
                            <input type="text" class="form-control" id="newName" name="newName" required pattern="[^\\/:*?&quot;&lt;&gt;|]+" title="Invalid characters">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                        <button type="submit" class="btn btn-primary">@Localizer["Rename"]</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/node_modules/dropify/dist/css/dropify.min.css" />
    <link rel="stylesheet" href="~/styles/uploader.css" />
    <style>
        .file-grid-card {
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        .file-grid-card .card-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            transform: translateY(100%);
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
            opacity: 0;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 0 !important;
        }
        .file-grid-card:hover .card-footer {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
}
@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script src="~/node_modules/dropify/dist/js/dropify.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#fileTable').DataTable({
                "destroy": true,
                "responsive": true,
                "paging": true,
                "pageLength": 25,
                "searching": true,
                "info": false,
                "order": [[0, "asc"]]
            });
        });

        function reloadPage() {
            location.reload();
        }

        function openRenameModal(currentName, currentPath) {
            document.getElementById('renamePath').value = currentPath;
            document.getElementById('newName').value = currentName;
            var renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
            renameModal.show();
        }

        function cutItem(siteName, path, name) {
            sessionStorage.setItem('clipboard', JSON.stringify({
                siteName: siteName,
                path: path,
                name: name
            }));
            checkClipboard();
        }

        function cancelCut() {
            sessionStorage.removeItem('clipboard');
            checkClipboard();
        }

        function checkClipboard() {
            var clipboard = sessionStorage.getItem('clipboard');
            var pasteForm = document.getElementById('pasteForm');
            var pasteSourcePath = document.getElementById('pasteSourcePath');
            var pasteButtonText = document.getElementById('pasteButtonText');

            if (clipboard) {
                var data = JSON.parse(clipboard);
                if (data.siteName === '@Model.SiteName') {
                    pasteForm.classList.remove('d-none');
                    pasteSourcePath.value = data.path;
                    pasteButtonText.innerText = '@Localizer["Paste"] ' + data.name;
                } else {
                    pasteForm.classList.add('d-none');
                }
            } else {
                pasteForm.classList.add('d-none');
            }
        }

        // View Toggle Logic
        var currentView = localStorage.getItem('fileManagerView') || 'list';

        function updateView() {
            if (currentView === 'grid') {
                $('#listView').addClass('d-none');
                $('#gridView').removeClass('d-none');
                $('#viewToggleIcon').removeClass('fa-th-large').addClass('fa-list');
                $('#viewToggleBtn').attr('title', '@Localizer["Switch to List View"]');
            } else {
                $('#gridView').addClass('d-none');
                $('#listView').removeClass('d-none');
                $('#viewToggleIcon').removeClass('fa-list').addClass('fa-th-large');
                $('#viewToggleBtn').attr('title', '@Localizer["Switch to Grid View"]');
            }
        }

        function toggleView() {
            currentView = currentView === 'list' ? 'grid' : 'list';
            localStorage.setItem('fileManagerView', currentView);
            updateView();
        }

        $(document).ready(function() {
            // Check clipboard on load
            checkClipboard();
            // Initialize view
            updateView();

            // Clear clipboard after successful paste
            $('#pasteForm').on('submit', function() {
                sessionStorage.removeItem('clipboard');
            });
        });
    </script>
}
