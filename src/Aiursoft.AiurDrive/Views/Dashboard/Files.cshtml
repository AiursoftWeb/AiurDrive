@model Aiursoft.AiurDrive.Models.DashboardViewModels.FileManagerViewModel
@inject Aiursoft.AiurDrive.Services.FileStorage.StorageService Storage
@using Aiursoft.CSTools.Tools
@{
    ViewData["Title"] = "File Manager - " + Model.SiteName;
    string GetFileIcon(string filename)
    {
        var extension = System.IO.Path.GetExtension(filename).TrimStart('.');
        var contentType = Aiursoft.AiurDrive.Services.Mime.GetContentType(extension);
        var iconName = contentType.Replace("/", "-");
        return $"/images/mimetypes/{iconName}.svg";
    }
}

<div class="container-fluid p-0">
    <!-- Breadcrumb -->
    <div class="pt-3 pb-2 mb-3 border-bottom">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="">
                        <i class="fas fa-home"></i> @Model.SiteName
                    </a>
                    @if (Model.OpenToUpload)
                    {
                        <span class="badge bg-success ms-1" style="font-size: 0.7em; vertical-align: middle;">@Localizer["Public"]</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary ms-1" style="font-size: 0.7em; vertical-align: middle;">@Localizer["Private"]</span>
                    }
                </li>
                @if (!string.IsNullOrEmpty(Model.Path))
                {
                    var parts = Model.Path.Split('/');
                    for (int i = 0; i < parts.Length; i++)
                    {
                        var part = parts[i];
                        var currentPath = string.Join("/", parts.Take(i + 1));

                        if (i == parts.Length - 1)
                        {
                            <li class="breadcrumb-item active" aria-current="page">@part</li>
                        }
                        else
                        {
                            <li class="breadcrumb-item">
                                <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@currentPath">@part</a>
                            </li>
                        }
                    }
                }
            </ol>
        </nav>
    </div>

    <div class="row">
        <!-- Sidebar / Stats -->
        <div class="col-sm-5 col-xl-3 mb-3">
            <div class="card">
                <div class="card-body">
                    @{
                        var usedSpaceGB = Model.UsedSpaceInBytes / 1024.0 / 1024.0 / 1024.0;
                        var totalSpaceGB = (double)Model.TotalSpaceInGB;
                        var percentage = (usedSpaceGB / totalSpaceGB) * 100;
                        var isFull = percentage >= 100;
                        var colorClass = percentage >= 100 ? "bg-danger" : percentage >= 80 ? "bg-warning" : "bg-success";
                    }

                    <div class="mb-3">
                        <label class="form-label small text-muted">@Localizer["Storage Usage"]</label>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar @colorClass" role="progressbar" style="width: @percentage%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between small text-muted mt-1">
                            <span>@usedSpaceGB.ToString("0.00") GB</span>
                            <span>@totalSpaceGB.ToString("0.00") GB</span>
                        </div>
                    </div>

                    @if (!isFull)
                    {
                        <div class="d-grid mb-3">
                             <!-- Upload Component -->
                             <h6 class="card-title">@Localizer["Upload File"]</h6>
                             <vc:file-upload
                                asp-for="UploadedFilePath"
                                upload-endpoint="@Url.Action("Upload", "Dashboard", new { siteName = Model.SiteName, path = Model.Path })"
                                allowed-extensions=""
                                max-size-in-mb="1024"
                                on-upload-success="reloadPage">
                            </vc:file-upload>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p class="mb-0">@Localizer["Storage Full"]</p>
                            <small>@Localizer["Delete some files to free up space."]</small>
                        </div>
                    }

                    <div class="d-grid mb-3">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                            <i class="fas fa-folder-plus"></i> @Localizer["New Folder"]
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- File List Container -->
        <div class="col-sm-7 col-xl-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        @Localizer["Files"]
                        @if(!string.IsNullOrEmpty(Model.Path)) { <span class="text-muted small">/ @Model.Path</span> }
                    </h5>
                    <div class="btn-toolbar">
                         <form asp-action="Move" asp-route-siteName="@Model.SiteName" method="post" id="pasteForm" class="d-none me-2">
                             <input type="hidden" name="sourcePath" id="pasteSourcePath" />
                             <input type="hidden" name="targetPath" value="@Model.Path" />
                             <button type="submit" class="btn btn-sm btn-outline-success">
                                 <i class="fas fa-paste"></i> <span id="pasteButtonText">@Localizer["Paste"]</span>
                             </button>
                             <button type="button" class="btn btn-sm btn-outline-danger" onclick="cancelCut()">
                                 <i class="fas fa-times"></i>
                             </button>
                         </form>

                         @if (!string.IsNullOrEmpty(Model.Path))
                         {
                             var parentPath = System.IO.Path.GetDirectoryName(Model.Path)?.Replace("\\", "/");
                             <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@parentPath" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-arrow-up"></i> @Localizer["Up Level"]
                            </a>
                         }

                         <button class="btn btn-sm btn-outline-secondary" onclick="toggleView()" id="viewToggleBtn" title="@Localizer["Toggle View"]">
                             <i class="fas fa-th-large" id="viewToggleIcon"></i>
                         </button>
                    </div>
                </div>
                <div class="card-body">

                    <!-- List View -->
                    <div id="listView">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="w-50">@Localizer["Name"]</th>
                                    <th>@Localizer["Date Modified"]</th>
                                    <th>@Localizer["Size"]</th>
                                    <th class="text-end">@Localizer["Actions"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var folder in Model.Folders)
                                {
                                    var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? folder : Model.Path + "/" + folder;
                                    <tr>
                                        <td>
                                            <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" class="text-reset fw-bold">
                                                <i class="fas fa-folder text-warning me-2"></i>@folder
                                            </a>
                                        </td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-light text-secondary" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@folder')">
                                                <i class="fas fa-cut"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-light text-primary" onclick="openRenameModal('@folder', '@currentRelativePath')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');">
                                                <button type="submit" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                                            </form>
                                        </td>
                                    </tr>
                                }

                                @foreach (var file in Model.Files)
                                {
                                    var logicalPath = System.IO.Path.Combine(Model.SiteName, Model.Path, file.Name).Replace("\\", "/");
                                    var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? file.Name : Model.Path + "/" + file.Name;
                                    var directUrl = Storage.RelativePathToInternetUrl(logicalPath, !Model.OpenToUpload);
                                    <tr>
                                        <td>
                                            <a href="@directUrl" target="_blank" class="text-reset">
                                                <i class="fas fa-file text-primary me-2"></i>@file.Name
                                            </a>
                                        </td>
                                        <td>@file.LastWriteTime.ToString("g")</td>
                                        <td>@((file.Length / 1024.0).ToString("N0")) KB</td>
                                        <td class="text-end">
                                            <a href="@directUrl" target="_blank" class="btn btn-sm btn-light"><i class="fas fa-download"></i></a>
                                            <button type="button" class="btn btn-sm btn-light text-secondary" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@file.Name')">
                                                <i class="fas fa-cut"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-light text-primary" onclick="openRenameModal('@file.Name', '@currentRelativePath')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                                <button type="submit" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button>
                                            </form>
                                        </td>
                                    </tr>
                                }

                                @if (!Model.Files.Any() && !Model.Folders.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">@Localizer["Folder is empty."]</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Grid View -->
                    <div id="gridView" class="d-none">
                        <div class="row">
                            @foreach (var folder in Model.Folders)
                            {
                                var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? folder : Model.Path + "/" + folder;
                                <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                                    <div class="card h-100 text-center file-grid-card">
                                        <a asp-action="Files" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" class="text-decoration-none text-dark flex-grow-1 d-flex flex-column align-items-center justify-content-center p-3">
                                            <i class="fas fa-folder fa-3x text-warning mb-2"></i>
                                            <span class="text-truncate w-100" title="@folder">@folder</span>
                                        </a>
                                        <div class="card-footer bg-transparent border-top-0">
                                            <div class="btn-group w-100">
                                                <button type="button" class="btn btn-light text-secondary py-2" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@folder')" title="@Localizer["Cut"]">
                                                    <i class="fas fa-cut"></i>
                                                </button>
                                                <button type="button" class="btn btn-light text-primary py-2" onclick="openRenameModal('@folder', '@currentRelativePath')" title="@Localizer["Rename"]">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-light text-danger py-2" onclick="if(confirm('Are you sure you want to delete this folder and all its contents?')) document.getElementById('delete-folder-@folder').submit();" title="@Localizer["Delete"]">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <!-- Hidden form for delete -->
                                            <form id="delete-folder-@folder" asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-none"></form>
                                        </div>
                                    </div>
                                </div>
                            }

                            @foreach (var file in Model.Files)
                            {
                                var logicalPath = System.IO.Path.Combine(Model.SiteName, Model.Path, file.Name).Replace("\\", "/");
                                var currentRelativePath = string.IsNullOrEmpty(Model.Path) ? file.Name : Model.Path + "/" + file.Name;
                                var directUrl = Storage.RelativePathToInternetUrl(logicalPath, !Model.OpenToUpload);
                                var isImage = file.Name.IsStaticImage();

                                <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                                    <div class="card h-100 text-center file-grid-card">
                                        <a href="@directUrl" target="_blank" class="text-decoration-none text-dark flex-grow-1 d-flex flex-column align-items-center justify-content-center p-3">
                                            @if (isImage)
                                            {
                                                var thumbUrl = directUrl + (directUrl.Contains("?") ? "&" : "?") + "w=200";
                                                <img src="@thumbUrl" class="img-fluid mb-2 rounded" style="max-height: 80px; object-fit: contain;" alt="@file.Name" />
                                            }
                                            else
                                            {
                                                <img src="@GetFileIcon(file.Name)" class="img-fluid mb-2" style="max-height: 80px;" alt="@file.Name" />
                                            }
                                            <span class="text-truncate w-100" title="@file.Name">@file.Name</span>
                                        </a>
                                        <div class="card-footer bg-transparent border-top-0">
                                             <div class="btn-group w-100">
                                                <button type="button" class="btn btn-light text-secondary py-2" onclick="cutItem('@Model.SiteName', '@currentRelativePath', '@file.Name')" title="@Localizer["Cut"]">
                                                    <i class="fas fa-cut"></i>
                                                </button>
                                                <button type="button" class="btn btn-light text-primary py-2" onclick="openRenameModal('@file.Name', '@currentRelativePath')" title="@Localizer["Rename"]">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-light text-danger py-2" onclick="if(confirm('Are you sure you want to delete this file?')) document.getElementById('delete-file-@file.Name').submit();" title="@Localizer["Delete"]">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <!-- Hidden form for delete -->
                                            <form id="delete-file-@file.Name" asp-action="Delete" asp-route-siteName="@Model.SiteName" asp-route-path="@currentRelativePath" method="post" class="d-none"></form>
                                        </div>
                                    </div>
                                </div>
                            }

                            @if (!Model.Files.Any() && !Model.Folders.Any())
                            {
                                <div class="col-12 text-center text-muted py-5">
                                    @Localizer["Folder is empty."]
                                </div>
                            }
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreateFolder" asp-route-siteName="@Model.SiteName" asp-route-path="@Model.Path" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer["New Folder"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newFolderName" class="form-label">@Localizer["Folder Name"]</label>
                        <input type="text" class="form-control" id="newFolderName" name="newFolderName" required pattern="[^\\/:*?&quot;&lt;&gt;|]+" title="Invalid characters">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-primary">@Localizer["Create"]</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Rename" asp-route-siteName="@Model.SiteName" method="post" id="renameForm">
                <input type="hidden" name="path" id="renamePath" />
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer["Rename"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newName" class="form-label">@Localizer["New Name"]</label>
                        <input type="text" class="form-control" id="newName" name="newName" required pattern="[^\\/:*?&quot;&lt;&gt;|]+" title="Invalid characters">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-primary">@Localizer["Rename"]</button>
                </div>
            </form>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section styles {
    <link rel="stylesheet" href="~/node_modules/dropify/dist/css/dropify.min.css" />
    <link rel="stylesheet" href="~/styles/uploader.css" />
    <style>
        .file-grid-card {
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        .file-grid-card .card-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            transform: translateY(100%);
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
            opacity: 0;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 0 !important;
        }
        .file-grid-card:hover .card-footer {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
}
@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script src="~/node_modules/dropify/dist/js/dropify.min.js"></script>
    <script>
        $(document).ready(function() {
            // Optional: Auto-refresh on upload completion if dropify supports events easily,
            // but standard dropify just shows the file.
            // We provided a Refresh button for now.
        });

        function reloadPage() {
            location.reload();
        }

        function openRenameModal(currentName, currentPath) {
            document.getElementById('renamePath').value = currentPath;
            document.getElementById('newName').value = currentName;
            var renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
            renameModal.show();
        }

        function cutItem(siteName, path, name) {
            sessionStorage.setItem('clipboard', JSON.stringify({
                siteName: siteName,
                path: path,
                name: name
            }));
            checkClipboard();
        }

        function cancelCut() {
            sessionStorage.removeItem('clipboard');
            checkClipboard();
        }

        function checkClipboard() {
            var clipboard = sessionStorage.getItem('clipboard');
            var pasteForm = document.getElementById('pasteForm');
            var pasteSourcePath = document.getElementById('pasteSourcePath');
            var pasteButtonText = document.getElementById('pasteButtonText');

            if (clipboard) {
                var data = JSON.parse(clipboard);
                if (data.siteName === '@Model.SiteName') {
                    pasteForm.classList.remove('d-none');
                    pasteSourcePath.value = data.path;
                    pasteButtonText.innerText = '@Localizer["Paste"] ' + data.name;
                } else {
                    pasteForm.classList.add('d-none');
                }
            } else {
                pasteForm.classList.add('d-none');
            }
        }

        // View Toggle Logic
        var currentView = localStorage.getItem('fileManagerView') || 'list';

        function updateView() {
            if (currentView === 'grid') {
                $('#listView').addClass('d-none');
                $('#gridView').removeClass('d-none');
                $('#viewToggleIcon').removeClass('fa-th-large').addClass('fa-list');
                $('#viewToggleBtn').attr('title', '@Localizer["Switch to List View"]');
            } else {
                $('#gridView').addClass('d-none');
                $('#listView').removeClass('d-none');
                $('#viewToggleIcon').removeClass('fa-list').addClass('fa-th-large');
                $('#viewToggleBtn').attr('title', '@Localizer["Switch to Grid View"]');
            }
        }

        function toggleView() {
            currentView = currentView === 'list' ? 'grid' : 'list';
            localStorage.setItem('fileManagerView', currentView);
            updateView();
        }

        $(document).ready(function() {
            // Check clipboard on load
            checkClipboard();
            // Initialize view
            updateView();

            // Clear clipboard after successful paste
            $('#pasteForm').on('submit', function() {
                sessionStorage.removeItem('clipboard');
            });
        });
    </script>
}
